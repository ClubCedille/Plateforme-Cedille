name: Create weekly issues discussion

on:
  workflow_dispatch:

permissions:
  contents: read
  issues: read
  discussions: write

env:
  GH_TOKEN: ${{ secrets.PROJECTS_TOKEN }}

jobs:
  create-discussion:
    runs-on: ubuntu-latest

    steps:
      - name: Fetch project issues and create discussion
        env:
          GH_TOKEN: ${{ secrets.PROJECTS_TOKEN }}
          ORG: ClubCedille
          TARGET_REPO: Plateforme-Cedille
          CATEGORY_ID: DIC_kwDOJzjWms4CyD_J
          PROJECT_ID: PVT_kwDOAGLsXs4AR-hq
          PROJECT_FIELD_ID: PVTSSF_lADOAGLsXs4AR-hqzggfaoM
          STATUS_FIELD_ID: PVTSSF_lADOAGLsXs4AR-hqzgLeuKs
        run: |
          gh --version
          set -e

          # Define project and status sort order
          PROJECT_ORDER=("Services" "Déploiements" "Plateforme-Cedille" "Club-ops" "Documentation & Onboarding" "Web Dev" "App Dev")
          STATUS_ORDER=("Backlog" "Todo" "In Progress" "In Review" "Done" "Won't Do")

          echo "Fetching project items with pagination..."

          # Initialize variables for pagination
          all_items="[]"
          has_next_page=true
          end_cursor=""

          # Fetch all pages
          while [ "$has_next_page" = "true" ]; do
            echo "Fetching page with cursor: ${end_cursor:-'(first page)'}"

            # Build query based on whether we have a cursor
            if [ -z "$end_cursor" ]; then
              # First page - no cursor
              page_data=$(gh api graphql -f query='
              query($project:ID!) {
                node(id: $project) {
                  ... on ProjectV2 {
                    items(first: 100) {
                      pageInfo {
                        hasNextPage
                        endCursor
                      }
                      nodes {
                        content {
                          ... on Issue {
                            title
                            url
                            number
                            repository {
                              name
                            }
                          }
                        }
                        fieldValues(first: 20) {
                          nodes {
                            ... on ProjectV2ItemFieldSingleSelectValue {
                              name
                              field {
                                ... on ProjectV2SingleSelectField {
                                  id
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }' -f project="$PROJECT_ID")
            else
              # Subsequent pages - with cursor
              page_data=$(gh api graphql -f query='
              query($project:ID!, $cursor:String!) {
                node(id: $project) {
                  ... on ProjectV2 {
                    items(first: 100, after: $cursor) {
                      pageInfo {
                        hasNextPage
                        endCursor
                      }
                      nodes {
                        content {
                          ... on Issue {
                            title
                            url
                            number
                            repository {
                              name
                            }
                          }
                        }
                        fieldValues(first: 20) {
                          nodes {
                            ... on ProjectV2ItemFieldSingleSelectValue {
                              name
                              field {
                                ... on ProjectV2SingleSelectField {
                                  id
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }' -f project="$PROJECT_ID" -f cursor="$end_cursor")
            fi

            # Extract pagination info
            has_next_page=$(echo "$page_data" | jq -r '.data.node.items.pageInfo.hasNextPage')
            end_cursor=$(echo "$page_data" | jq -r '.data.node.items.pageInfo.endCursor')

            # Append items to all_items
            page_items=$(echo "$page_data" | jq '.data.node.items.nodes')
            all_items=$(echo "$all_items" | jq --argjson page "$page_items" '. + $page')

            echo "Fetched $(echo "$page_items" | jq 'length') items. Total: $(echo "$all_items" | jq 'length')"
          done

          echo "Total items fetched: $(echo "$all_items" | jq 'length')"

          echo "Formatting and sorting issues..."

          formatted=$(echo "$all_items" | jq -r --argjson PROJECT_ORDER "$(printf '%s\n' "${PROJECT_ORDER[@]}" | jq -R . | jq -s .)" \
          --argjson STATUS_ORDER "$(printf '%s\n' "${STATUS_ORDER[@]}" | jq -R . | jq -s .)" \
          --arg PROJECT_FIELD_ID "$PROJECT_FIELD_ID" \
          --arg STATUS_FIELD_ID "$STATUS_FIELD_ID" \
          '
          map(
            select(.content != null)
            | {
              title: .content.title,
              url: (.content.url // ""),
              repo: (.content.repository.name // "No Repo"),
              project: (.fieldValues.nodes[] | select(.field.id == $PROJECT_FIELD_ID) | .name // "No Project"),
              status: (.fieldValues.nodes[] | select(.field.id == $STATUS_FIELD_ID) | .name // "No Status")
            }
          )
          | sort_by(
            (.project as $p | $PROJECT_ORDER | index($p) // 999),
            (.status as $s | $STATUS_ORDER | index($s) // 999)
          )
          | group_by(.project)
          | map(
            "## " + (.[0].project) + "\n\n" +
            (
              group_by(.status)
              | map(
                "### " + (.[0].status) + "\n" +
                (map(
                  "- [" + .repo + "] " + .title +
                  (if .url != "" then " (" + .url + ")" else "" end)
                ) | join("\n"))
              )
              | join("\n\n")
            )
          )
          | join("\n\n")
          ')

          body=$(cat <<EOF
          ## Weekly project overview – Backlog CEDILLE

          $formatted
          EOF
          )

          echo "Resolving repository ID..."

          REPO_ID=$(gh api graphql -f query='
          query($owner:String!, $name:String!) {
            repository(owner: $owner, name: $name) {
              id
            }
          }' -f owner="$ORG" -f name="$TARGET_REPO" --jq '.data.repository.id')

          echo "Repository ID: $REPO_ID"

          echo "Creating discussion..."

          gh api graphql -f query='
          mutation($repoId:ID!, $title:String!, $body:String!, $category:ID!) {
            createDiscussion(input:{
              repositoryId: $repoId
              title: $title
              body: $body
              categoryId: $category
            }) {
              discussion {
                url
              }
            }
          }' \
          -f repoId="$REPO_ID" \
          -f title="Weekly issues report ($(date +%Y-%m-%d))" \
          -f body="$body" \
          -f category="$CATEGORY_ID"
