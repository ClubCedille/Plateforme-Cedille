name: Create weekly issues discussion

on:
  workflow_dispatch:

permissions:
  contents: read
  issues: read
  discussions: write

env:
  GH_TOKEN: ${{ secrets.PROJECTS_TOKEN }}

jobs:
  create-discussion:
    runs-on: ubuntu-latest

    steps:
      - name: Fetch project issues and create discussion
        env:
          GH_TOKEN: ${{ secrets.PROJECTS_TOKEN }}
          ORG: ClubCedille
          TARGET_REPO: Plateforme-Cedille
          CATEGORY_ID: DIC_kwDOJzjWms4CyD_J
          PROJECT_ID: PVT_kwDOAGLsXs4AR-hq
          PROJECT_FIELD_ID: PVTSSF_lADOAGLsXs4AR-hqzggfaoM
          STATUS_FIELD_ID: PVTSSF_lADOAGLsXs4AR-hqzgLeuKs
        run: |
          gh --version
          set -e

          # Define project and status sort order
          PROJECT_ORDER=("Services" "Déploiements" "Plateforme-Cedille" "Club-ops" "Documentation & Onboarding" "Web Dev" "App Dev")
          STATUS_ORDER=("Backlog" "Todo" "In Progress" "In Review" "Done" "Won't Do")

          echo "Fetching project items with pagination..."
          echo "PROJECT_ID: $PROJECT_ID"
          echo "PROJECT_FIELD_ID: $PROJECT_FIELD_ID"
          echo "STATUS_FIELD_ID: $STATUS_FIELD_ID"

          all_items="[]"
          cursor=""
          page_count=0

          while : ; do
            page_count=$((page_count + 1))
            echo "Fetching page $page_count..."

            if [ -z "$cursor" ]; then
              page=$(gh api graphql -f query='
              query($project:ID!) {
                node(id: $project) {
                  ... on ProjectV2 {
                    items(first: 100) {
                      pageInfo {
                        hasNextPage
                        endCursor
                      }
                      nodes {
                        content {
                          ... on Issue {
                            title
                            url
                            repository {
                              name
                            }
                          }
                        }
                        fieldValues(first: 20) {
                          nodes {
                            ... on ProjectV2ItemFieldSingleSelectValue {
                              field {
                                ... on ProjectV2Field {
                                  id
                                }
                              }
                              name
                            }
                            ... on ProjectV2ItemFieldTextValue {
                              field {
                                ... on ProjectV2Field {
                                  id
                                }
                              }
                              text
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }' -f project="$PROJECT_ID")
            else
              page=$(gh api graphql -f query='
              query($project:ID!, $after:String) {
                node(id: $project) {
                  ... on ProjectV2 {
                    items(first: 100, after: $after) {
                      pageInfo {
                        hasNextPage
                        endCursor
                      }
                      nodes {
                        content {
                          ... on Issue {
                            title
                            url
                            repository {
                              name
                            }
                          }
                        }
                        fieldValues(first: 20) {
                          nodes {
                            ... on ProjectV2ItemFieldSingleSelectValue {
                              field {
                                ... on ProjectV2Field {
                                  id
                                }
                              }
                              name
                            }
                            ... on ProjectV2ItemFieldTextValue {
                              field {
                                ... on ProjectV2Field {
                                  id
                                }
                              }
                              text
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }' -f project="$PROJECT_ID" -f after="$cursor")
            fi

            # Log the raw response
            echo "Raw page response:"
            echo "$page" | jq '.'

            # Count items in this page
            items_count=$(echo "$page" | jq '.data.node.items.nodes | length')
            echo "Items in page $page_count: $items_count"

            # Merge items
            all_items=$(echo "$page" | jq -c --argjson acc "$all_items" '
              $acc + (.data.node.items.nodes // [])
            ')

            # Log merged items count
            total_items=$(echo "$all_items" | jq 'length')
            echo "Total items so far: $total_items"

            # Pagination
            hasNext=$(echo "$page" | jq -r '.data.node.items.pageInfo.hasNextPage')
            cursor=$(echo "$page" | jq -r '.data.node.items.pageInfo.endCursor')
            echo "Has next page: $hasNext"
            [ "$hasNext" != "true" ] && break
          done

          echo "============================================"
          echo "Total pages fetched: $page_count"
          echo "Total items collected: $(echo "$all_items" | jq 'length')"
          echo "============================================"

          # Log sample of collected items
          echo "Sample of collected items (first 2):"
          echo "$all_items" | jq '.[0:2]'

          echo "Formatting and sorting issues..."

          # First, let's see what field IDs are actually present
          echo "Analyzing field structure:"
          echo "$all_items" | jq '[.[0].fieldValues.nodes[] | {field: .field, name: .name, text: .text}]'

          # Check if any items have the expected field IDs
          echo "Checking for PROJECT_FIELD_ID matches:"
          echo "$all_items" | jq --arg PROJECT_FIELD_ID "$PROJECT_FIELD_ID" '[.[].fieldValues.nodes[] | select(.field.id == $PROJECT_FIELD_ID)]'

          echo "Checking for STATUS_FIELD_ID matches:"
          echo "$all_items" | jq --arg STATUS_FIELD_ID "$STATUS_FIELD_ID" '[.[].fieldValues.nodes[] | select(.field.id == $STATUS_FIELD_ID)]'

          formatted=$(echo "$all_items" | jq -r \
          --arg PROJECT_FIELD_ID "$PROJECT_FIELD_ID" \
          --arg STATUS_FIELD_ID "$STATUS_FIELD_ID" \
          --argjson PROJECT_ORDER "$(printf '%s\n' "${PROJECT_ORDER[@]}" | jq -R . | jq -s .)" \
          --argjson STATUS_ORDER "$(printf '%s\n' "${STATUS_ORDER[@]}" | jq -R . | jq -s .)" \
          '
          map(
            select(.content != null)
            | {
              title: .content.title,
              url: (.content.url // ""),
              repo: (.content.repository.name // "No Repo"),
              project: (.fieldValues.nodes[] | select(.field.id == $PROJECT_FIELD_ID) | .name // .text // "No Project"),
              status: (.fieldValues.nodes[] | select(.field.id == $STATUS_FIELD_ID) | .name // .text // "No Status"),
              debug_fields: [.fieldValues.nodes[] | {id: .field.id, name: .name, text: .text}]
            }
          )
          | map(. + {debug: "project=\(.project), status=\(.status)"})
          | sort_by(
            ($PROJECT_ORDER | index(.project) // 999),
            ($STATUS_ORDER | index(.status) // 999)
          )
          | group_by(.project)
          | map(
            "## " + (.[0].project) + "\n\n" +
            (
              group_by(.status)
              | map(
                "### " + (.[0].status) + "\n" +
                (map(
                  "- [" + .repo + "] " + .title +
                  (if .url != "" then " (" + .url + ")" else "" end)
                ) | join("\n"))
              )
              | join("\n\n")
            )
          )
          | join("\n\n")
          ')

          echo "============================================"
          echo "Formatted output length: ${#formatted}"
          echo "Formatted output preview:"
          echo "$formatted" | head -20
          echo "============================================"

          body=$(cat <<EOF
          ## Weekly project overview – Backlog CEDILLE

          $formatted
          EOF
          )

          echo "Final body length: ${#body}"

          echo "Resolving repository ID..."
          REPO_ID=$(gh api graphql -f query='
          query($owner:String!, $name:String!) {
            repository(owner: $owner, name: $name) {
              id
            }
          }' -f owner="$ORG" -f name="$TARGET_REPO" --jq '.data.repository.id')

          echo "Repository ID: $REPO_ID"
          echo "Creating discussion..."
          gh api graphql -f query='
          mutation($repoId:ID!, $title:String!, $body:String!, $category:ID!) {
            createDiscussion(input:{
              repositoryId: $repoId
              title: $title
              body: $body
              categoryId: $category
            }) {
              discussion { url }
            }
          }' \
          -f repoId="$REPO_ID" \
          -f title="Weekly issues report ($(date +%Y-%m-%d))" \
          -f body="$body" \
          -f category="$CATEGORY_ID"
